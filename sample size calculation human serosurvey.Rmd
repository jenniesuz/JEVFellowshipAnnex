---
title: "Sample size calculation"
author: "Jen"
date: "2025-09-23"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
# load packages
library(GLMMmisc) # available via devtools::install_github("pcdjohnson/GLMMmisc")
library(lme4)
library(parallel)
library(binom)
library(plyr)
library(ggplot2)
library(lmtest)
library(grid)
library(gridExtra)

# load functions required
source("SeroprevalenceFOISimFunc.R")

```

## Sample size calculation for estimating JEV force of infection to humans

Estimates from Chapai Nawabganj by Duque et al. 2024 (https://www.science.org/doi/10.1126/sciadv.adp1657) indicate 19% seroprevalence and average force of infection of 0.007 per year. This compares with estimates from Quan et al (2020) (https://elifesciences.org/articles/51027) 0.001 in Japan to 0.507 in Guigang China. Besides those extreme values, FOI were generally between 0.05 and 0.2 with a median of 0.09.


Function to calculate prevalence as a function of age based on FOI:
```{r}
propImmFunc(lambda=0.009, age=20)*100  
```

```{r}
propImmFunc(lambda=0.005, age=20)*100  
```
A difference in FOI of 0.02 around the mean of 0.07 would lead to a difference in seroprevalence by age 20 of c. half

Simulate data as example before power analysis:
```{r}
dat <- simulateSeroprevalence(lowLambda=0.005
                                    ,highLambda=0.009
                                    ,n.village=36
                                    ,n.hh=30
                                    ,people.in.household=1
                                    ,ageMin=5
                                    ,ageMax=90
                                    ,sdLogFOI=1.5
                                    ,ageSD=1.2)

dat$ageGroup <- NA
dat$ageGroup[(dat$age > 5)&(dat$age <= 15)] <- 10
dat$ageGroup[(dat$age > 16)&(dat$age <= 25)] <- 20
dat$ageGroup[(dat$age > 26)&(dat$age <= 35)] <- 30
dat$ageGroup[(dat$age > 36)&(dat$age <= 45)] <- 40
dat$ageGroup[(dat$age > 46)&(dat$age <= 55)] <- 50
dat$ageGroup[(dat$age > 56)&(dat$age <= 65)] <- 60
dat$ageGroup[(dat$age > 66)&(dat$age <= 75)] <- 70
dat$ageGroup[(dat$age > 76)&(dat$age <= 85)] <- 80
dat$ageGroup[(dat$age > 86)&(dat$age <= 95)] <- 90

datSummary <- ddply(dat,.(risk.level,ageGroup),summarise,propImm=sum(Infected),total=length(Infected))

ci <- binom.confint(x=datSummary$propImm,n=datSummary$total,methods="exact")
datSummary$mean <- ci$mean
datSummary$lower <- ci$lower
datSummary$upper <- ci$upper
```

The simulateSeroprevalence function adds noise at the village and household level - the amount of variation is set by sdLogFOI and ageSD (using a lognormal distribution)
```{r}
ggplot(datSummary) +
  geom_point(aes(x=ageGroup,y=mean,col=as.factor(risk.level))) +
  geom_errorbar(aes(x=ageGroup,ymin=lower,ymax=upper,col=as.factor(risk.level)))
```



Simulate data, fit model many times for a range of household numbers across 36 villages (predetermined)

```{r}
numHH <- c(5:45)

# repeat simulations many times and calculate p-value
cl <- makeCluster(detectCores()-1)               # get cores from your computer - 1
clusterExport(cl, varlist=c("simulateSeroprevalence","propImmFuncV","accPrecFunc","lrtest"),
              envir=environment())               


  start <- Sys.time()
  sim.res <- parLapply(cl,numHH,function(x){
    nsim <- 1
    risk <- numeric(nsim)
    intercept <- numeric(nsim)
    ao <- numeric(nsim)
    ll=0.005
    hl=0.009
    while(nsim<1000){
      dat <- simulateSeroprevalence(lowLambda=ll
                                    ,highLambda=hl
                                    ,n.village=36
                                    ,n.hh=x
                                    ,people.in.household=1
                                    ,ageMin=5
                                    ,ageMax=90
                                    ,sdLogFOI=1.5
                                    ,ageSD=2 )
    
      fit <- glm(Infected~risk.level
                 ,family=binomial(link="cloglog")
                 ,offset=log(age)
                 ,data=dat)

     fit0 <- update(fit, ~ . - risk.level)
     ao[nsim] <- lrtest(fit, fit0)[2, "Pr(>Chisq)"]
     
     risk[nsim] <- coef(fit)[2]
     intercept[nsim] <- coef(fit)[1]
     nsim <- nsim+1
    }
       
    mseRisk <- accPrecFunc(risk.level=risk,llambda=ll,hlambda=hl)
    ss <- x*36*1
    pwr <- length(ao[ao<=0.05])/nsim
  return(c(ss,mseRisk,pwr))
  }) 
stopCluster(cl)   # stop the clusters
end <- Sys.time()
end - start


sims <- do.call(rbind.data.frame,sim.res)
names(sims) <- c("samplesize","MSERisk","pwr")


```
Plot

```{r}
msePlot <- ggplot(sims) +
  geom_point(aes(x=samplesize,y=MSERisk)) +
  xlab("Sample size") +
  ylab("Mean squared error") +
  theme(text = element_text(size = 12))

pwerPlot <- ggplot(sims) +
  geom_point(aes(x=samplesize,y=pwr*100)) +
  xlab("Sample size") +
  ylab("Power (%)") +
  theme(text = element_text(size = 12))

grid.arrange(msePlot,pwerPlot,ncol=2)
#ggsave(filename = "figpwrplot.png", device = "png")
```


